<!DOCTYPE html>
<html>
  <head>
    <title>Ahoy - Simple, Powerful Visit Tracking for Rails</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="github.css">
    <style>
      body {
        padding-bottom: 20px;
      }

      .container {
        max-width: 800px;
      }

      h2, h3, h4 {
        margin-top: 1em;
      }

      p {
        margin-top: 1.5em;
        margin-bottom: 1.5em;
      }

      p.lead {
        margin-top: 0;
      }
    </style>

    <meta property="og:title" content="Ahoy"/>
    <meta property="og:url" content="http://ankane.github.io/ahoy/"/>
    <meta property="og:image" content="https://github.global.ssl.fastly.net/images/gravatars/gravatar-user-420.png"/>
    <meta property="og:description" content="Simple, powerful visit tracking for Rails"/>

    <script src="//www.google.com/jsapi"></script>
    <script src="chartkick.js"></script>
  </head>
  <body>
    <a href="https://github.com/ankane/ahoy" style="position: fixed; top: 15px; right: 15px; border: 0; z-index: 1000;" class="btn btn-info">Github</a>

    <div class="container">
      <div class="row">
        <div class="col-sm-12">
          <h1 style="margin-bottom: 0.5em; margin-top: 15px;">Ahoy</h1>
        </div>
      </div>
      <div class="row">
        <div class="col-sm-12">
          <p class="lead"><img class="emoji" title=":fire:" alt=":fire:" src="https://github.global.ssl.fastly.net/images/icons/emoji/fire.png" height="20" width="20" align="absmiddle"> A solid foundation for analytics on Rails</p>
        </div>
      </div>
      <div class="row">
        <div class="col-sm-12">
          <hr style="margin-top: 0;" />

<!-- begin readme -->

<p>Ahoy provides a solid foundation to track visits and events in Ruby, JavaScript, and native apps.</p>

<p>Works with any data store so you can easily scale.</p>

<p><img class="emoji" title=":postbox:" alt=":postbox:" src="https://assets-cdn.github.com/images/icons/emoji/postbox.png" height="20" width="20" align="absmiddle"> To track emails, check out <a href="https://github.com/ankane/ahoy_email">Ahoy Email</a>.</p>

<p>See <a href="#upgrading">upgrade instructions</a> on how to move to 1.0.</p>

<h2>
<a name="user-content-installation" class="anchor" href="#installation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Installation</h2>

<p>Add this line to your application’s Gemfile:</p>

<div class="highlight highlight-ruby"><pre><span class="n">gem</span> <span class="s1">'ahoy_matey'</span>
</pre></div>

<p>And add the javascript file in <code>app/assets/javascripts/application.js</code> after jQuery.</p>

<div class="highlight highlight-javascript"><pre><span class="c1">//= require jquery</span>
<span class="c1">//= require ahoy</span>
</pre></div>

<h2>
<a name="user-content-choose-a-data-store" class="anchor" href="#choose-a-data-store" aria-hidden="true"><span class="octicon octicon-link"></span></a>Choose a Data Store</h2>

<h3>
<a name="user-content-activerecord" class="anchor" href="#activerecord" aria-hidden="true"><span class="octicon octicon-link"></span></a>ActiveRecord</h3>

<h4>
<a name="user-content-postgresql" class="anchor" href="#postgresql" aria-hidden="true"><span class="octicon octicon-link"></span></a>PostgreSQL</h4>

<div class="highlight highlight-sh"><pre>rails generate ahoy:stores:active_record -d postgresql
rake db:migrate
</pre></div>

<h4>
<a name="user-content-mysql-and-sqlite" class="anchor" href="#mysql-and-sqlite" aria-hidden="true"><span class="octicon octicon-link"></span></a>MySQL and SQLite</h4>

<p>Add <a href="https://github.com/jashmenn/activeuuid">activeuuid</a> to your Gemfile.</p>

<div class="highlight highlight-ruby"><pre><span class="n">gem</span> <span class="s1">'activeuuid'</span><span class="p">,</span> <span class="s1">'&gt;= 0.5.0'</span>
</pre></div>

<p>And run:</p>

<div class="highlight highlight-sh"><pre>rails generate ahoy:stores:active_record
rake db:migrate
</pre></div>

<p>If you just want visits, run:</p>

<div class="highlight highlight-sh"><pre>rails generate ahoy:stores:active_record_visits
rake db:migrate
</pre></div>

<h3>
<a name="user-content-mongoid" class="anchor" href="#mongoid" aria-hidden="true"><span class="octicon octicon-link"></span></a>Mongoid</h3>

<div class="highlight highlight-sh"><pre>rails generate ahoy:stores:mongoid
</pre></div>

<h3>
<a name="user-content-logs" class="anchor" href="#logs" aria-hidden="true"><span class="octicon octicon-link"></span></a>Logs</h3>

<div class="highlight highlight-sh"><pre>rails generate ahoy:stores:log
</pre></div>

<p>This logs visits to <code>log/visits.log</code> and events to <code>log/events.log</code>.</p>

<h3>
<a name="user-content-custom" class="anchor" href="#custom" aria-hidden="true"><span class="octicon octicon-link"></span></a>Custom</h3>

<div class="highlight highlight-sh"><pre>rails generate ahoy:stores:custom
</pre></div>

<p>This creates a class for you to fill out.</p>

<div class="highlight highlight-ruby"><pre><span class="k">class</span> <span class="nc">Ahoy</span><span class="o">::</span><span class="no">Store</span> <span class="o">&lt;</span> <span class="no">Ahoy</span><span class="o">::</span><span class="no">Stores</span><span class="o">::</span><span class="no">BaseStore</span>

  <span class="k">def</span> <span class="nf">track_visit</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">track_event</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">properties</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div>

<p>See the <a href="https://github.com/ankane/ahoy/blob/master/lib/ahoy/stores/active_record_store.rb">ActiveRecordStore</a> for an example.</p>

<h2>
<a name="user-content-how-it-works" class="anchor" href="#how-it-works" aria-hidden="true"><span class="octicon octicon-link"></span></a>How It Works</h2>

<h3>
<a name="user-content-visits" class="anchor" href="#visits" aria-hidden="true"><span class="octicon octicon-link"></span></a>Visits</h3>

<p>When someone visits your website, Ahoy creates a visit with lots of useful information.</p>

<ul class="task-list">
<li>
<strong>traffic source</strong> - referrer, referring domain, landing page, search keyword</li>
<li>
<strong>location</strong> - country, region, and city</li>
<li>
<strong>technology</strong> - browser, OS, and device type</li>
<li>
<strong>utm parameters</strong> - source, medium, term, content, campaign</li>
</ul><p>Use the <code>current_visit</code> method to access it.</p>

<h3>
<a name="user-content-events" class="anchor" href="#events" aria-hidden="true"><span class="octicon octicon-link"></span></a>Events</h3>

<p>Each event has a <code>name</code> and <code>properties</code>.</p>

<p>There are three ways to track events.</p>

<h4>
<a name="user-content-javascript" class="anchor" href="#javascript" aria-hidden="true"><span class="octicon octicon-link"></span></a>JavaScript</h4>

<div class="highlight highlight-javascript"><pre><span class="nx">ahoy</span><span class="p">.</span><span class="nx">track</span><span class="p">(</span><span class="s2">"Viewed book"</span><span class="p">,</span> <span class="p">{</span><span class="nx">title</span><span class="o">:</span> <span class="s2">"The World is Flat"</span><span class="p">});</span>
</pre></div>

<p>or track events automatically with:</p>

<div class="highlight highlight-javascript"><pre><span class="nx">ahoy</span><span class="p">.</span><span class="nx">trackAll</span><span class="p">();</span>
</pre></div>

<p>See <a href="https://github.com/ankane/ahoy.js">Ahoy.js</a> for a complete list of features.</p>

<h4>
<a name="user-content-ruby" class="anchor" href="#ruby" aria-hidden="true"><span class="octicon octicon-link"></span></a>Ruby</h4>

<div class="highlight highlight-ruby"><pre><span class="n">ahoy</span><span class="o">.</span><span class="n">track</span> <span class="s2">"Viewed book"</span><span class="p">,</span> <span class="ss">title</span><span class="p">:</span> <span class="s2">"Hot, Flat, and Crowded"</span>
</pre></div>

<h4>
<a name="user-content-native-apps" class="anchor" href="#native-apps" aria-hidden="true"><span class="octicon octicon-link"></span></a>Native Apps</h4>

<p>See the <a href="#native-apps">HTTP spec</a> until libraries are built.</p>

<h3>
<a name="user-content-users" class="anchor" href="#users" aria-hidden="true"><span class="octicon octicon-link"></span></a>Users</h3>

<p>Ahoy automatically attaches the <code>current_user</code> to the visit.</p>

<p>With <a href="https://github.com/plataformatec/devise">Devise</a>, it will attach the user even if he or she signs in after the visit starts.</p>

<p>With other authentication frameworks, add this to the end of your sign in method:</p>

<div class="highlight highlight-ruby"><pre><span class="n">ahoy</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</pre></div>

<h2>
<a name="user-content-customize-the-store" class="anchor" href="#customize-the-store" aria-hidden="true"><span class="octicon octicon-link"></span></a>Customize the Store</h2>

<p>Stores are built to be highly customizable.</p>

<div class="highlight highlight-ruby"><pre><span class="k">class</span> <span class="nc">Ahoy</span><span class="o">::</span><span class="no">Store</span> <span class="o">&lt;</span> <span class="no">Ahoy</span><span class="o">::</span><span class="no">Stores</span><span class="o">::</span><span class="no">ActiveRecordStore</span>
  <span class="c1"># add methods here</span>
<span class="k">end</span>
</pre></div>

<h3>
<a name="user-content-exclude-bots-and-more" class="anchor" href="#exclude-bots-and-more" aria-hidden="true"><span class="octicon octicon-link"></span></a>Exclude Bots and More</h3>

<p>Exclude visits and events from being tracked with:</p>

<div class="highlight highlight-ruby"><pre><span class="k">class</span> <span class="nc">Ahoy</span><span class="o">::</span><span class="no">Store</span> <span class="o">&lt;</span> <span class="no">Ahoy</span><span class="o">::</span><span class="no">Stores</span><span class="o">::</span><span class="no">ActiveRecordStore</span>

  <span class="k">def</span> <span class="nf">exclude?</span>
    <span class="n">bot?</span> <span class="o">||</span> <span class="n">request</span><span class="o">.</span><span class="n">ip</span> <span class="o">==</span> <span class="s2">"192.168.1.1"</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div>

<p>Bots are excluded by default.</p>

<h3>
<a name="user-content-track-additional-values" class="anchor" href="#track-additional-values" aria-hidden="true"><span class="octicon octicon-link"></span></a>Track Additional Values</h3>

<div class="highlight highlight-ruby"><pre><span class="k">class</span> <span class="nc">Ahoy</span><span class="o">::</span><span class="no">Store</span> <span class="o">&lt;</span> <span class="no">Ahoy</span><span class="o">::</span><span class="no">Stores</span><span class="o">::</span><span class="no">ActiveRecordStore</span>

  <span class="k">def</span> <span class="nf">track_visit</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
    <span class="k">super</span> <span class="k">do</span> <span class="o">|</span><span class="n">visit</span><span class="o">|</span>
      <span class="n">visit</span><span class="o">.</span><span class="n">gclid</span> <span class="o">=</span> <span class="n">visit_properties</span><span class="o">.</span><span class="n">landing_params</span><span class="o">[</span><span class="s2">"gclid"</span><span class="o">]</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">track_event</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">properties</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
    <span class="k">super</span> <span class="k">do</span> <span class="o">|</span><span class="n">event</span><span class="o">|</span>
      <span class="n">event</span><span class="o">.</span><span class="n">ip</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">ip</span>
    <span class="k">end</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div>

<h3>
<a name="user-content-customize-user" class="anchor" href="#customize-user" aria-hidden="true"><span class="octicon octicon-link"></span></a>Customize User</h3>

<p>If you use a method other than <code>current_user</code>, set it here:</p>

<div class="highlight highlight-ruby"><pre><span class="k">class</span> <span class="nc">Ahoy</span><span class="o">::</span><span class="no">Store</span> <span class="o">&lt;</span> <span class="no">Ahoy</span><span class="o">::</span><span class="no">Stores</span><span class="o">::</span><span class="no">ActiveRecordStore</span>

  <span class="k">def</span> <span class="nf">user</span>
    <span class="n">controller</span><span class="o">.</span><span class="n">true_user</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div>

<h3>
<a name="user-content-report-exceptions" class="anchor" href="#report-exceptions" aria-hidden="true"><span class="octicon octicon-link"></span></a>Report Exceptions</h3>

<p>Exceptions are rescued so analytics do not break your app.</p>

<p>To report them to a service, use:</p>

<div class="highlight highlight-ruby"><pre><span class="k">class</span> <span class="nc">Ahoy</span><span class="o">::</span><span class="no">Store</span> <span class="o">&lt;</span> <span class="no">Ahoy</span><span class="o">::</span><span class="no">Stores</span><span class="o">::</span><span class="no">ActiveRecordStore</span>

  <span class="k">def</span> <span class="nf">report_exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="no">Rollbar</span><span class="o">.</span><span class="n">report_exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div>

<h3>
<a name="user-content-use-different-models" class="anchor" href="#use-different-models" aria-hidden="true"><span class="octicon octicon-link"></span></a>Use Different Models</h3>

<p>For ActiveRecord and Mongoid stores</p>

<div class="highlight highlight-ruby"><pre><span class="k">class</span> <span class="nc">Ahoy</span><span class="o">::</span><span class="no">Store</span> <span class="o">&lt;</span> <span class="no">Ahoy</span><span class="o">::</span><span class="no">Stores</span><span class="o">::</span><span class="no">ActiveRecordStore</span>

  <span class="k">def</span> <span class="nf">visit_model</span>
    <span class="no">CustomVisit</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">event_model</span>
    <span class="no">CustomEvent</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div>

<h2>
<a name="user-content-more-features" class="anchor" href="#more-features" aria-hidden="true"><span class="octicon octicon-link"></span></a>More Features</h2>

<h3>
<a name="user-content-automatic-tracking" class="anchor" href="#automatic-tracking" aria-hidden="true"><span class="octicon octicon-link"></span></a>Automatic Tracking</h3>

<p>Page views</p>

<div class="highlight highlight-javascript"><pre><span class="nx">ahoy</span><span class="p">.</span><span class="nx">trackView</span><span class="p">();</span>
</pre></div>

<p>Clicks</p>

<div class="highlight highlight-javascript"><pre><span class="nx">ahoy</span><span class="p">.</span><span class="nx">trackClicks</span><span class="p">();</span>
</pre></div>

<p>Rails actions</p>

<div class="highlight highlight-ruby"><pre><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">after_filter</span> <span class="ss">:track_action</span>

  <span class="kp">protected</span>

  <span class="k">def</span> <span class="nf">track_action</span>
    <span class="n">ahoy</span><span class="o">.</span><span class="n">track</span> <span class="s2">"Processed </span><span class="si">#{</span><span class="n">controller_name</span><span class="si">}</span><span class="s2">#</span><span class="si">#{</span><span class="n">action_name</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">filtered_parameters</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<h3>
<a name="user-content-multiple-subdomains" class="anchor" href="#multiple-subdomains" aria-hidden="true"><span class="octicon octicon-link"></span></a>Multiple Subdomains</h3>

<p>To track visits across multiple subdomains, use:</p>

<div class="highlight highlight-ruby"><pre><span class="no">Ahoy</span><span class="o">.</span><span class="n">cookie_domain</span> <span class="o">=</span> <span class="ss">:all</span>
</pre></div>

<h3>
<a name="user-content-visit-duration" class="anchor" href="#visit-duration" aria-hidden="true"><span class="octicon octicon-link"></span></a>Visit Duration</h3>

<p>By default, a new visit is created after 4 hours of inactivity.</p>

<p>Change this with:</p>

<div class="highlight highlight-ruby"><pre><span class="no">Ahoy</span><span class="o">.</span><span class="n">visit_duration</span> <span class="o">=</span> <span class="mi">30</span><span class="o">.</span><span class="n">minutes</span>
</pre></div>

<h3>
<a name="user-content-activerecord-1" class="anchor" href="#activerecord-1" aria-hidden="true"><span class="octicon octicon-link"></span></a>ActiveRecord</h3>

<p>Let’s associate orders with visits.</p>

<div class="highlight highlight-ruby"><pre><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">visitable</span>
<span class="k">end</span>
</pre></div>

<p>When a visitor places an order, the <code>visit_id</code> column is automatically set.</p>

<p><img class="emoji" title=":tada:" alt=":tada:" src="https://assets-cdn.github.com/images/icons/emoji/tada.png" height="20" width="20" align="absmiddle"> Magic!</p>

<p>Customize the column and class name with:</p>

<div class="highlight highlight-ruby"><pre><span class="n">visitable</span> <span class="ss">:sign_up_visit</span><span class="p">,</span> <span class="ss">class_name</span><span class="p">:</span> <span class="s2">"Visit"</span>
</pre></div>

<h3>
<a name="user-content-doorkeeper" class="anchor" href="#doorkeeper" aria-hidden="true"><span class="octicon octicon-link"></span></a>Doorkeeper</h3>

<p>To attach the user with <a href="https://github.com/doorkeeper-gem/doorkeeper">Doorkeeper</a>, be sure you have a <code>current_resource_owner</code> method in <code>ApplicationController</code>.</p>

<div class="highlight highlight-ruby"><pre><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">current_resource_owner</span>
    <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">doorkeeper_token</span><span class="o">.</span><span class="n">resource_owner_id</span><span class="p">)</span> <span class="k">if</span> <span class="n">doorkeeper_token</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div>

<h3>
<a name="user-content-track-visits-immediately" class="anchor" href="#track-visits-immediately" aria-hidden="true"><span class="octicon octicon-link"></span></a>Track Visits Immediately</h3>

<p>Visitor and visit ids are generated on the first request (so you can use them immediately), but the <code>track_visit</code> method isn’t called until the JavaScript library posts to the server.  This prevents browsers with cookies disabled from creating multiple visits and ensures visits are not created for API endpoints.  Change this with:</p>

<div class="highlight highlight-ruby"><pre><span class="no">Ahoy</span><span class="o">.</span><span class="n">track_visits_immediately</span> <span class="o">=</span> <span class="kp">true</span>
</pre></div>

<p><strong>Note:</strong> At the moment, geocoding is performed in the foreground, which can slow down the first page load.</p>

<p>You can exclude API endpoints and other actions with:</p>

<div class="highlight highlight-ruby"><pre><span class="n">skip_before_filter</span> <span class="ss">:track_ahoy_visit</span>
</pre></div>

<h2>
<a name="user-content-development" class="anchor" href="#development" aria-hidden="true"><span class="octicon octicon-link"></span></a>Development</h2>

<p>Ahoy is built with developers in mind.  You can run the following code in your browser’s console.</p>

<p>Force a new visit</p>

<div class="highlight highlight-javascript"><pre><span class="nx">ahoy</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span> <span class="c1">// then reload the page</span>
</pre></div>

<p>Log messages</p>

<div class="highlight highlight-javascript"><pre><span class="nx">ahoy</span><span class="p">.</span><span class="nx">debug</span><span class="p">();</span>
</pre></div>

<p>Turn off logging</p>

<div class="highlight highlight-javascript"><pre><span class="nx">ahoy</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
</pre></div>

<p>Debug endpoint requests in Ruby</p>

<div class="highlight highlight-ruby"><pre><span class="no">Ahoy</span><span class="o">.</span><span class="n">quiet</span> <span class="o">=</span> <span class="kp">false</span>
</pre></div>

<h2>
<a name="user-content-explore-the-data" class="anchor" href="#explore-the-data" aria-hidden="true"><span class="octicon octicon-link"></span></a>Explore the Data</h2>

<p>How you explore the data depends on the data store used.</p>

<p>Here are ways to do it with ActiveRecord.</p>

<div class="highlight highlight-ruby"><pre><span class="no">Visit</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="ss">:search_keyword</span><span class="p">)</span><span class="o">.</span><span class="n">count</span>
<span class="no">Visit</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="ss">:country</span><span class="p">)</span><span class="o">.</span><span class="n">count</span>
<span class="no">Visit</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="ss">:referring_domain</span><span class="p">)</span><span class="o">.</span><span class="n">count</span>
</pre></div>

<p><a href="http://chartkick.com/">Chartkick</a> and <a href="https://github.com/ankane/groupdate">Groupdate</a> make it super easy to visualize the data.</p>

<div class="highlight highlight-erb"><pre><span class="cp">&lt;%=</span> <span class="n">line_chart</span> <span class="no">Visit</span><span class="o">.</span><span class="n">group_by_day</span><span class="p">(</span><span class="ss">:created_at</span><span class="p">)</span><span class="o">.</span><span class="n">count</span> <span class="cp">%&gt;</span><span class="x"></span>
</pre></div>

<p>See where orders are coming from with simple joins:</p>

<div class="highlight highlight-ruby"><pre><span class="no">Order</span><span class="o">.</span><span class="n">joins</span><span class="p">(</span><span class="ss">:visit</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">"referring_domain"</span><span class="p">)</span><span class="o">.</span><span class="n">count</span>
<span class="no">Order</span><span class="o">.</span><span class="n">joins</span><span class="p">(</span><span class="ss">:visit</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">"city"</span><span class="p">)</span><span class="o">.</span><span class="n">count</span>
<span class="no">Order</span><span class="o">.</span><span class="n">joins</span><span class="p">(</span><span class="ss">:visit</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">"device_type"</span><span class="p">)</span><span class="o">.</span><span class="n">count</span>
</pre></div>

<p>To see the visits for a given user, create an association:</p>

<div class="highlight highlight-ruby"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_many</span> <span class="ss">:visits</span>
<span class="k">end</span>
</pre></div>

<p>And use:</p>

<div class="highlight highlight-ruby"><pre><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span>
<span class="n">user</span><span class="o">.</span><span class="n">visits</span>
</pre></div>

<h3>
<a name="user-content-create-funnels" class="anchor" href="#create-funnels" aria-hidden="true"><span class="octicon octicon-link"></span></a>Create Funnels</h3>

<div class="highlight highlight-ruby"><pre><span class="n">viewed_store_ids</span> <span class="o">=</span> <span class="no">Ahoy</span><span class="o">::</span><span class="no">Event</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">"Viewed store"</span><span class="p">)</span><span class="o">.</span><span class="n">uniq</span><span class="o">.</span><span class="n">pluck</span><span class="p">(</span><span class="ss">:user_id</span><span class="p">)</span>
<span class="n">added_item_ids</span> <span class="o">=</span> <span class="no">Ahoy</span><span class="o">::</span><span class="no">Event</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">user_id</span><span class="p">:</span> <span class="n">viewed_store_ids</span><span class="p">,</span> <span class="nb">name</span><span class="p">:</span> <span class="s2">"Added item to cart"</span><span class="p">)</span><span class="o">.</span><span class="n">uniq</span><span class="o">.</span><span class="n">pluck</span><span class="p">(</span><span class="ss">:user_id</span><span class="p">)</span>
<span class="n">viewed_checkout_ids</span> <span class="o">=</span> <span class="no">Ahoy</span><span class="o">::</span><span class="no">Event</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">user_id</span><span class="p">:</span> <span class="n">added_item_ids</span><span class="p">,</span> <span class="nb">name</span><span class="p">:</span> <span class="s2">"Viewed checkout"</span><span class="p">)</span><span class="o">.</span><span class="n">uniq</span><span class="o">.</span><span class="n">pluck</span><span class="p">(</span><span class="ss">:user_id</span><span class="p">)</span>
</pre></div>

<p>The same approach also works with visitor ids.</p>

<h2>
<a name="user-content-native-apps-1" class="anchor" href="#native-apps-1" aria-hidden="true"><span class="octicon octicon-link"></span></a>Native Apps</h2>

<h3>
<a name="user-content-visits-1" class="anchor" href="#visits-1" aria-hidden="true"><span class="octicon octicon-link"></span></a>Visits</h3>

<p>When a user launches the app, create a visit.</p>

<p>Generate a <code>visit_id</code> and <code>visitor_id</code> as <a href="http://en.wikipedia.org/wiki/Universally_unique_identifier">UUIDs</a>.</p>

<p>Send these values in the <code>Ahoy-Visit</code> and <code>Ahoy-Visitor</code> headers with all requests.</p>

<p>Send a <code>POST</code> request to <code>/ahoy/visits</code> with:</p>

<ul class="task-list">
<li>platform - <code>iOS</code>, <code>Android</code>, etc.</li>
<li>app_version - <code>1.0.0</code>
</li>
<li>os_version - <code>7.0.6</code>
</li>
</ul><p>After 4 hours of inactivity, create another visit and use the updated visit id.</p>

<h3>
<a name="user-content-events-1" class="anchor" href="#events-1" aria-hidden="true"><span class="octicon octicon-link"></span></a>Events</h3>

<p>Send a <code>POST</code> request as <code>Content-Type: application/json</code> to <code>/ahoy/events</code> with:</p>

<ul class="task-list">
<li>id - <code>5aea7b70-182d-4070-b062-b0a09699ad5e</code> - UUID</li>
<li>name - <code>Viewed item</code>
</li>
<li>properties - <code>{"item_id": 123}</code>
</li>
<li>time - <code>2014-06-17T00:00:00-07:00</code> - <a href="https://en.wikipedia.org/wiki/ISO_8601">ISO 8601</a>
</li>
<li>
<code>Ahoy-Visit</code> and <code>Ahoy-Visitor</code> headers</li>
<li>user token (depends on your authentication framework)</li>
</ul><p>Use an array to pass multiple events at once.</p>

<h2>
<a name="user-content-upgrading" class="anchor" href="#upgrading" aria-hidden="true"><span class="octicon octicon-link"></span></a>Upgrading</h2>

<h3>
<a name="user-content-100" class="anchor" href="#100" aria-hidden="true"><span class="octicon octicon-link"></span></a>1.0.0</h3>

<p>Add the following code to the end of <code>config/intializers/ahoy.rb</code>.</p>

<div class="highlight highlight-ruby"><pre><span class="k">class</span> <span class="nc">Ahoy</span><span class="o">::</span><span class="no">Store</span> <span class="o">&lt;</span> <span class="no">Ahoy</span><span class="o">::</span><span class="no">Stores</span><span class="o">::</span><span class="no">ActiveRecordTokenStore</span>
  <span class="n">uses_deprecated_subscribers</span>
<span class="k">end</span>
</pre></div>

<p>If you use <code>Ahoy::Event</code> to track events, copy it into your project.</p>

<div class="highlight highlight-ruby"><pre><span class="k">module</span> <span class="nn">Ahoy</span>
  <span class="k">class</span> <span class="nc">Event</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">table_name</span> <span class="o">=</span> <span class="s2">"ahoy_events"</span>

    <span class="n">belongs_to</span> <span class="ss">:visit</span>
    <span class="n">belongs_to</span> <span class="ss">:user</span><span class="p">,</span> <span class="ss">polymorphic</span><span class="p">:</span> <span class="kp">true</span>

    <span class="n">serialize</span> <span class="ss">:properties</span><span class="p">,</span> <span class="no">JSON</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<p>That’s it!  To fix deprecations, keep reading.</p>

<h4>
<a name="user-content-visits-2" class="anchor" href="#visits-2" aria-hidden="true"><span class="octicon octicon-link"></span></a>Visits</h4>

<p>Remove <code>ahoy_visit</code> from your visit model and replace it with:</p>

<div class="highlight highlight-ruby"><pre><span class="k">class</span> <span class="nc">Visit</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span><span class="p">,</span> <span class="ss">polymorphic</span><span class="p">:</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div>

<h4>
<a name="user-content-subscribers" class="anchor" href="#subscribers" aria-hidden="true"><span class="octicon octicon-link"></span></a>Subscribers</h4>

<p>Remove <code>uses_deprecated_subscribers</code> from <code>Ahoy::Store</code>.</p>

<p>If you have a custom subscriber, copy the <code>track</code> method to <code>track_event</code> in <code>Ahoy::Store</code>.</p>

<div class="highlight highlight-ruby"><pre><span class="k">class</span> <span class="nc">Ahoy</span><span class="o">::</span><span class="no">Store</span> <span class="o">&lt;</span> <span class="no">Ahoy</span><span class="o">::</span><span class="no">Stores</span><span class="o">::</span><span class="no">ActiveRecordTokenStore</span>

  <span class="k">def</span> <span class="nf">track_event</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">properties</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
    <span class="c1"># code copied from the track method in your subscriber</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div>

<h4>
<a name="user-content-authentication" class="anchor" href="#authentication" aria-hidden="true"><span class="octicon octicon-link"></span></a>Authentication</h4>

<p>Ahoy no longer tracks the <code>$authenticate</code> event automatically.</p>

<p>To restore this behavior, use:</p>

<div class="highlight highlight-ruby"><pre><span class="k">class</span> <span class="nc">Ahoy</span><span class="o">::</span><span class="no">Store</span> <span class="o">&lt;</span> <span class="no">Ahoy</span><span class="o">::</span><span class="no">Stores</span><span class="o">::</span><span class="no">ActiveRecordTokenStore</span>

  <span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="k">super</span>
    <span class="n">ahoy</span><span class="o">.</span><span class="n">track</span> <span class="s2">"$authenticate"</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div>

<h4>
<a name="user-content-global-options" class="anchor" href="#global-options" aria-hidden="true"><span class="octicon octicon-link"></span></a>Global Options</h4>

<p>Replace the <code>Ahoy.user_method</code> with <code>user</code> method, and replace <code>Ahoy.track_bots</code> and <code>Ahoy.exclude_method</code> with <code>exclude?</code> method.</p>

<p>Skip this step if you do not use these options.</p>

<div class="highlight highlight-ruby"><pre><span class="k">class</span> <span class="nc">Ahoy</span><span class="o">::</span><span class="no">Store</span> <span class="o">&lt;</span> <span class="no">Ahoy</span><span class="o">::</span><span class="no">Stores</span><span class="o">::</span><span class="no">ActiveRecordTokenStore</span>

  <span class="k">def</span> <span class="nf">user</span>
    <span class="c1"># logic from Ahoy.user_method goes here</span>
    <span class="n">controller</span><span class="o">.</span><span class="n">true_user</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">exclude?</span>
    <span class="c1"># logic from Ahoy.track_bots and Ahoy.exclude_method goes here</span>
    <span class="n">bot?</span> <span class="o">||</span> <span class="n">request</span><span class="o">.</span><span class="n">ip</span> <span class="o">==</span> <span class="s2">"192.168.1.1"</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div>

<p>You made it!  Now, take advantage of Ahoy’s awesome new features, like easy customization and exception reporting.</p>

<h3>
<a name="user-content-030" class="anchor" href="#030" aria-hidden="true"><span class="octicon octicon-link"></span></a>0.3.0</h3>

<p>Starting with <code>0.3.0</code>, visit and visitor tokens are now UUIDs.</p>

<h3>
<a name="user-content-016" class="anchor" href="#016" aria-hidden="true"><span class="octicon octicon-link"></span></a>0.1.6</h3>

<p>In <code>0.1.6</code>, a big improvement was made to <code>browser</code> and <code>os</code>. Update existing visits with:</p>

<div class="highlight highlight-ruby"><pre><span class="no">Visit</span><span class="o">.</span><span class="n">find_each</span> <span class="k">do</span> <span class="o">|</span><span class="n">visit</span><span class="o">|</span>
  <span class="n">visit</span><span class="o">.</span><span class="n">set_technology</span>
  <span class="n">visit</span><span class="o">.</span><span class="n">save!</span> <span class="k">if</span> <span class="n">visit</span><span class="o">.</span><span class="n">changed?</span>
<span class="k">end</span>
</pre></div>

<h2>
<a name="user-content-todo" class="anchor" href="#todo" aria-hidden="true"><span class="octicon octicon-link"></span></a>TODO</h2>

<ul class="task-list">
<li>simple dashboard</li>
<li>turn off modules</li>
</ul><h2>
<a name="user-content-no-ruby" class="anchor" href="#no-ruby" aria-hidden="true"><span class="octicon octicon-link"></span></a>No Ruby?</h2>

<p>Check out <a href="https://github.com/ankane/ahoy.js">Ahoy.js</a>.</p>

<h2>
<a name="user-content-history" class="anchor" href="#history" aria-hidden="true"><span class="octicon octicon-link"></span></a>History</h2>

<p>View the <a href="https://github.com/ankane/ahoy/blob/master/CHANGELOG.md">changelog</a></p>

<h2>
<a name="user-content-contributing" class="anchor" href="#contributing" aria-hidden="true"><span class="octicon octicon-link"></span></a>Contributing</h2>

<p>Everyone is encouraged to help improve this project. Here are a few ways you can help:</p>

<ul class="task-list">
<li><a href="https://github.com/ankane/ahoy/issues">Report bugs</a></li>
<li>Fix bugs and <a href="https://github.com/ankane/ahoy/pulls">submit pull requests</a>
</li>
<li>Write, clarify, or fix documentation</li>
<li>Suggest or add new features</li>
</ul>

<!-- end readme -->

        </div>
      </div>
    </div>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-39027070-8', 'ankane.github.io');
      ga('send', 'pageview');
    </script>

  </body>
</html>
